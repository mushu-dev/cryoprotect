/**
 * Script to generate TypeScript types for Convex API
 * 
 * This script generates TypeScript type definitions for the Convex database schema,
 * making sure our frontend code is type-safe when interacting with Convex.
 */

const { execSync } = require('child_process');
const path = require('path');
const fs = require('fs');

// Path configuration
const GENERATED_DIR = path.join(__dirname, '..', 'src', 'convex', 'generated');
const CONVEX_CONFIG_PATH = path.join(__dirname, '..', 'convex.json');

// Create the generated directory if it doesn't exist
if (!fs.existsSync(GENERATED_DIR)) {
  console.log(`Creating directory: ${GENERATED_DIR}`);
  fs.mkdirSync(GENERATED_DIR, { recursive: true });
}

// Read Convex configuration
let convexConfig;
try {
  convexConfig = JSON.parse(fs.readFileSync(CONVEX_CONFIG_PATH, 'utf8'));
} catch (err) {
  console.error('Error reading Convex configuration:', err);
  process.exit(1);
}

// Check if the Convex URL is set in the environment
const convexUrl = process.env.NEXT_PUBLIC_CONVEX_URL || convexConfig.origin;
if (!convexUrl) {
  console.error('Error: NEXT_PUBLIC_CONVEX_URL is not set and no origin in convex.json');
  process.exit(1);
}

console.log(`Generating Convex types from ${convexUrl}...`);

try {
  // Run the Convex codegen command
  execSync(`npx convex codegen --router-mode dev --type-mode types ${convexUrl}`, {
    stdio: 'inherit'
  });
  
  console.log(`Types successfully generated in ${GENERATED_DIR}`);
} catch (err) {
  console.error('Error generating Convex types:', err);
  process.exit(1);
}

// Create an index.ts file to export the generated types
const indexContent = `/**
 * Generated Convex API types
 * 
 * This file re-exports the generated Convex API types for easier imports.
 * DO NOT EDIT THIS FILE DIRECTLY. It is automatically generated.
 */

export * from './api';
export * from './dataModel';
export * from './server';
`;

fs.writeFileSync(path.join(GENERATED_DIR, 'index.ts'), indexContent);
console.log('Created index.ts for easier imports');

console.log('Successfully generated Convex types!');